<h2>5. Plan de Manejo (ADCAVANDIMELCO)</h2>

<div class="calc-card" style="border: 2px solid var(--accent);">
    <div class="grid">
        <div class="field">
            <label><b>Peso para Cálculos (g):</b></label>
            <input type="number" id="pesoCalc" placeholder="Se toma del Examen Físico" oninput="calcularADCAV()">
            <small style="color:blue">Viene de la sección anterior</small>
        </div>
        <div class="field">
            <label>Líquidos Totales (ml/kg/d):</label>
            <input type="number" id="liqTot" value="80" oninput="calcularADCAV()">
        </div>
        <div class="field">
            <label>VIG (mg/kg/min):</label>
            <input type="number" id="vig" value="4" step="0.1" oninput="calcularADCAV()">
        </div>
    </div>

    <div id="areaResultados" style="margin-top:15px;">
        <div class="adcav-item">
            <div class="adcav-header">
                <span>A - ALIMENTACIÓN Y LÍQUIDOS</span>
                <span id="res_vol_dia" class="res-destacado" style="background:#fff; padding:2px 8px; border-radius:4px;">0 ml/día</span>
            </div>
            <textarea id="plan_A" style="width:100%; border:none; background:transparent; font-family:inherit;" rows="3"></textarea>
            <div style="margin-top:5px; font-weight:bold; color:var(--accent);" id="res_bomba">Ritmo: 0 cc/h</div>
        </div>

        <div class="adcav-item">
            <div class="adcav-header">D - DIURESIS Y DESTINO</div>
            <input type="text" id="plan_D" value="Control de diuresis y deposiciones. Termocuna." style="width:100%">
        </div>

        <div class="adcav-item">
            <div class="adcav-header">C - CONTROLES Y SIGNOS VITALES</div>
            <input type="text" id="plan_C" value="CSV cada 3 horas + SatO2 continua." style="width:100%">
        </div>

        <div class="adcav-item">
            <div class="adcav-header">A - ACTIVIDAD Y POSICIÓN</div>
            <input type="text" id="plan_Act" value="Reposo, posición semifowler, mínima manipulación." style="width:100%">
        </div>

        <div class="adcav-item">
            <div class="adcav-header">V - VITAMINAS Y MEDICAMENTOS</div>
            <textarea id="plan_V" style="width:100%; border:none; background:transparent;" rows="2">Fitomenadiona 1mg IM (DU). Profilaxis ocular.</textarea>
        </div>
    </div>
</div>

<script>
    // Esta función ahora sí conecta los datos
    function calcularADCAV() {
        // Intentamos obtener el peso del campo de arriba o del campo de la sección 3
        const pesoG = parseFloat(document.getElementById('pesoCalc').value) || 
                      parseFloat(document.getElementById('peso')?.value) || 0;
        
        const liqKg = parseFloat(document.getElementById('liqTot').value) || 0;
        const vigDeseado = parseFloat(document.getElementById('vig').value) || 0;
        
        if (pesoG > 0) {
            const pesoKg = pesoG / 1000;
            const volTotal = (liqKg * pesoKg).toFixed(1);
            const ritmo = (volTotal / 24).toFixed(1);
            
            // Cálculo de Dextrosa para el VIG (Simplificado para el plan)
            // VIG = (cc/h * %Dextrosa) / (6 * pesoKg)
            // %Dextrosa = (VIG * 6 * pesoKg) / ritmo
            let percDextrosa = (vigDeseado * 6 * pesoKg) / ritmo;
            if(isNaN(percDextrosa)) percDextrosa = 10;

            document.getElementById('res_vol_dia').innerText = volTotal + " ml/día";
            document.getElementById('res_bomba').innerText = "RITMO EN BOMBA: " + ritmo + " cc/h";
            
            document.getElementById('plan_A').value = 
                `NPO + Líquidos IV.\nPrescripción: Dextrosa al ${percDextrosa.toFixed(1)}% ${volTotal}ml IV para 24h a pasar a ${ritmo} cc/h.\nVIG: ${vigDeseado} mg/kg/min.`;
        } else {
            document.getElementById('res_vol_dia').innerText = "Ingrese peso...";
            document.getElementById('res_bomba').innerText = "Ritmo: 0 cc/h";
        }
    }

    // Ejecutar al cargar para que no aparezca vacío
    window.onload = function() {
        // Si hay un peso guardado en la sección 3, lo traemos
        const pesoPrevio = document.getElementById('peso')?.value;
        if(pesoPrevio) document.getElementById('pesoCalc').value = pesoPrevio;
        calcularADCAV();
    };
</script>
