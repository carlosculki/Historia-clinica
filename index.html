<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA NEONATAL INTEGRAL HSVP - v4.0</title>
    <style>
        :root { --primary: #2c3e50; --secondary: #3498db; --accent: #27ae60; --bg: #f4f7f6; --warning: #f1c40f; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); padding: 10px; font-size: 12px; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 10px solid var(--primary); }
        
        h2 { background: var(--primary); color: white; padding: 12px; border-radius: 6px; font-size: 1.3em; border-left: 10px solid var(--secondary); margin-top: 25px; display: flex; justify-content: space-between; }
        .grid-filiacion { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; }
        
        /* Buscadores */
        .search-container { position: relative; margin-bottom: 10px; }
        .results-list { position: absolute; background: white; border: 1px solid #ccc; width: 100%; z-index: 1000; max-height: 200px; overflow-y: auto; border-radius: 0 0 8px 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none; }
        .results-list div { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .results-list div:hover { background: #e3f2fd; color: #1976d2; }

        /* Examen Físico */
        .ef-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px; }
        .ef-item { background: #fff; border: 1px solid #ddd; padding: 8px; border-radius: 5px; }
        .ef-item label { font-weight: bold; color: var(--primary); display: block; margin-bottom: 4px; }

        /* ADCAV y Medicamentos */
        .adcav-card { border: 1px solid #d1d8e0; border-radius: 10px; overflow: hidden; margin-top: 15px; }
        .adcav-row { display: grid; grid-template-columns: 80px 1fr; border-bottom: 1px solid #eee; background: white; }
        .adcav-letter { background: #eef2f7; color: var(--secondary); font-size: 2.5em; font-weight: bold; display: flex; align-items: center; justify-content: center; border-right: 2px solid #3498db; }
        .adcav-content { padding: 15px; }
        
        .med-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; }
        .med-table th { background: var(--primary); color: white; padding: 8px; }
        .med-table td { border: 1px solid #ddd; padding: 6px; text-align: center; }

        .calc-box { background: #fffde7; border: 2px solid #f1c40f; padding: 15px; border-radius: 8px; font-weight: bold; font-size: 1.1em; color: #d35400; }
        
        textarea, input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn-action { background: var(--accent); color: white; padding: 15px 30px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1.2em; margin-top: 20px; transition: 0.3s; }
        .btn-action:hover { background: #219150; transform: translateY(-2px); }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align: center; color: var(--primary); margin-bottom: 5px;">SISTEMA NEONATAL HSVP</h1>
    <p style="text-align: center; color: #7f8c8d; margin-bottom: 30px;">Integración Total: Filiación, Antecedentes, Examen Físico, CIE-10 y ADCAV</p>

    <h2>1. DATOS DE FILIACIÓN Y EDAD</h2>
    <div class="grid-filiacion">
        <div><label>Nombre Paciente:</label><input type="text" id="nombre"></div>
        <div><label>HCU:</label><input type="text" id="hcu"></div>
        <div><label>Fecha Nacimiento:</label><input type="datetime-local" id="fNac" onchange="calcularEdades()"></div>
        <div><label>Fecha Ingreso:</label><input type="datetime-local" id="fIng" onchange="calcularEdades()"></div>
        <div><label>Peso al nacer (g):</label><input type="number" id="p_nacer" value="3000"></div>
        <div><label>Semanas Gestación:</label><input type="number" id="semG" value="38" oninput="calcularEdades()"></div>
        <div><label>Edad Cronológica:</label><input type="text" id="edadCron" readonly style="background:#e9ecef;"></div>
        <div><label>Edad Corregida:</label><input type="text" id="edadCorr" readonly style="background:#e9ecef;"></div>
    </div>

    <h2>2. ANTECEDENTES PERINATALES</h2>
    <div class="search-container">
        <input type="text" id="busAnt" placeholder="Buscar antecedentes (ej: Preeclampsia, RPM, Diabetes...)" onkeyup="buscarEnDB(this.value, 'dbAnt', 'resAnt', 'listaAnt')">
        <div id="resAnt" class="results-list"></div>
        <textarea id="listaAnt" rows="3" style="margin-top:10px;" placeholder="Antecedentes seleccionados..."></textarea>
    </div>

    <h2>3. EXAMEN FÍSICO</h2>
    <div class="ef-grid" id="efInputs">
        <div class="ef-item"><label>Piel</label><select onchange="actualizarEF()"><option value="Rosada, elástica, hidratada.">Normal</option><option value="Ictericia Kramer II.">Ictericia</option><option value="Cianosis distal.">Cianosis</option></select></div>
        <div class="ef-item"><label>Cabeza</label><select onchange="actualizarEF()"><option value="Fontanela normotensa, suturas afrontadas.">Normal</option><option value="Caput succedaneum.">Caput</option></select></div>
        <div class="ef-item"><label>Tórax</label><select onchange="actualizarEF()"><option value="Simétrico, ruidos cardiacos rítmicos.">Normal</option><option value="Retracciones leves.">Distrés</option></select></div>
        <div class="ef-item"><label>Pulmones</label><select onchange="actualizarEF()"><option value="Murmullo vesicular conservado.">Normal</option><option value="Estertores basales.">Estertores</option></select></div>
        <div class="ef-item"><label>Abdomen</label><select onchange="actualizarEF()"><option value="Suave, deprimible, ruidos hidroaéreos (+).">Normal</option></select></div>
        <div class="ef-item"><label>Neurológico</label><select onchange="actualizarEF()"><option value="Activo, reactivo, reflejos primarios presentes.">Normal</option><option value="Hipotónico.">Hipotónico</option></select></div>
    </div>
    <textarea id="efFinal" rows="3" style="margin-top:10px; background:#fdfdfd;" placeholder="Relato del examen físico..."></textarea>

    <h2>4. DIAGNÓSTICOS (CIE-10)</h2>
    <div class="search-container">
        <input type="text" id="busCIE" placeholder="Buscar diagnóstico CIE-10..." onkeyup="buscarEnDB(this.value, 'dbCIE', 'resCIE', 'diagFinal')">
        <div id="resCIE" class="results-list"></div>
        <textarea id="diagFinal" rows="3" style="margin-top:10px; font-weight:bold; color:#2c3e50;"></textarea>
    </div>

    <h2>5. PLAN DE MANEJO (ADCAV)</h2>
    <div class="adcav-card">
        <div class="adcav-row">
            <div class="adcav-letter">A</div>
            <div class="adcav-content">
                <b>ALIMENTACIÓN:</b> 
                <select id="tipoDieta" onchange="recalcularFluidos()" style="width:200px">
                    <option value="NPO">NADA POR VIA ORAL (NPO)</option>
                    <option value="LM">LECHE MATERNA (LM)</option>
                </select>
                <span id="boxDieta" style="display:none; margin-left:15px;">
                    ml: <input type="number" id="dietCant" style="width:60px" oninput="recalcularFluidos()"> 
                    Frec(h): <input type="number" id="dietFreq" value="3" style="width:50px" oninput="recalcularFluidos()">
                </span>
            </div>
        </div>
        <div class="adcav-row">
            <div class="adcav-letter">D</div>
            <div class="adcav-content"><b>DIAGNÓSTICOS:</b> Ver sección superior.</div>
        </div>
        <div class="adcav-row">
            <div class="adcav-letter">C</div>
            <div class="adcav-content"><b>CONDICIÓN:</b> <select style="width:200px"><option>ESTABLE</option><option>CUIDADO INTERMEDIO</option><option>CRÍTICO</option></select></div>
        </div>
        <div class="adcav-row">
            <div class="adcav-letter">A</div>
            <div class="adcav-content"><b>ALERGIAS:</b> <input type="text" value="NO REFIERE / NEGATIVO" style="width:300px"></div>
        </div>
        <div class="adcav-row">
            <div class="adcav-letter">V</div>
            <div class="adcav-content"><b>VITALES:</b> <input type="text" value="CSV cada 3 horas, Monitoreo continuo, Balance Hídrico."></div>
        </div>
        <div class="adcav-row">
            <div class="adcav-letter">I</div>
            <div class="adcav-content">
                <b>INFUSIONES Y LÍQUIDOS:</b>
                <div style="background:#f1f2f6; padding:10px; border-radius:5px; margin-bottom:10px;">
                    <div style="display:flex; gap:20px;">
                        <div>Peso Actual (g): <input type="number" id="p_actual" value="3000" oninput="recalcularFluidos()" style="width:80px"></div>
                        <div>Líquidos Totales (ml/kg/d): <input type="number" id="lt_meta" value="80" oninput="recalcularFluidos()" style="width:70px"></div>
                        <div>% Dextrosa: <input type="number" id="dexPerc" value="10" oninput="recalcularFluidos()" style="width:60px"></div>
                        <div style="background:#fff; padding:5px; border:1px solid #ccc;">
                            <label><input type="checkbox" id="foto" onchange="recalcularFluidos()"> Fototerapia (+15%)</label>
                            <label><input type="checkbox" id="cuna" onchange="recalcularFluidos()"> Cuna Rad. (+15%)</label>
                        </div>
                    </div>
                </div>
                <div id="resFinalIV" class="calc-box">Calculando plan hídrico...</div>
            </div>
        </div>
        <div class="adcav-row">
            <div class="adcav-letter">M</div>
            <div class="adcav-content">
                <b>MEDICAMENTOS:</b>
                <table class="med-table">
                    <thead><tr><th>Fármaco</th><th>Dosis/kg</th><th>Frec(h)</th><th>Conc(mg/ml)</th><th>¿Restar de IV?</th><th>Vol/día</th><th></th></tr></thead>
                    <tbody id="bodyMed"></tbody>
                </table>
                <button onclick="agregarMed()" style="margin-top:10px; padding:5px 15px;">+ Añadir Medicamento</button>
            </div>
        </div>
    </div>

    <button class="btn-action" onclick="alert('Datos listos para copiar al formulario 005')">FINALIZAR Y GENERAR REGISTROS</button>
</div>

<script>
    // BASES DE DATOS INTEGRALES
    const dbCIE = [
        {c:"P59.9", d:"ICTERICIA NEONATAL, NO ESPECIFICADA"},
        {c:"P22.0", d:"SINDROME DE DIFICULTAD RESPIRATORIA DEL RECIEN NACIDO"},
        {c:"P36.9", d:"SEPSIS BACTERIANA DEL RECIEN NACIDO, NO ESPECIFICADA"},
        {c:"P07.3", d:"OTROS RECIEN NACIDOS PRETERMINO (34-36 SEMANAS)"},
        {c:"P70.4", d:"OTRAS HIPOGLICEMIAS NEONATALES"},
        {c:"Z00.1", d:"CONTROL DE SALUD DE RUTINA DEL NIÑO"}
    ];

    const dbAnt = [
        "MADRE PRIMIGESTA", "CONTROLES PRENATALES ADECUADOS", "RUPTURA PREMATURA DE MEMBRANAS > 18H", 
        "PREECLAMPSIA CON SIGNOS DE SEVERIDAD", "DIABETES GESTACIONAL", "ITU TERCER TRIMESTRE TRATADA"
    ];

    const dbMeds = {
        "AMPICILINA": {d:50, c:100, f:12, b:true},
        "GENTAMICINA": {d:4, c:4, f:24, b:true},
        "AMIKACINA": {d:15, c:5, f:24, b:true},
        "CEFTAZIDIMA": {d:50, c:40, f:12, b:true},
        "GLUCONATO DE CALCIO 10%": {d:200, c:50, f:24, b:true}
    };

    let listaMedicamentos = [];

    // LÓGICA DE EDAD
    function calcularEdades() {
        const nac = new Date(document.getElementById('fNac').value);
        const ing = new Date(document.getElementById('fIng').value);
        const semG = parseInt(document.getElementById('semG').value);

        if(!isNaN(nac)) {
            let diffMs = ing - nac;
            let totalHoras = Math.floor(diffMs / 3600000);
            
            // Cronológica
            if(totalHoras < 48) document.getElementById('edadCron').value = totalHoras + " HORAS";
            else document.getElementById('edadCron').value = Math.floor(totalHoras/24) + " DÍAS";

            // Corregida (Si es < 40 sem)
            if(semG < 40) {
                let diasExtra = Math.floor(totalHoras / 24);
                let semCorregidas = semG + Math.floor(diasExtra / 7);
                let diasCorregidos = diasExtra % 7;
                document.getElementById('edadCorr').value = semCorregidas + " SEM. " + diasCorregidos + " DÍAS";
            } else {
                document.getElementById('edadCorr').value = "A TÉRMINO";
            }
        }
        recalcularFluidos();
    }

    // BUSCADORES
    function buscarEnDB(query, dbName, resId, targetId) {
        const resDiv = document.getElementById(resId);
        resDiv.innerHTML = '';
        if(query.length < 2) { resDiv.style.display = 'none'; return; }

        let data = dbName === 'dbCIE' ? dbCIE : dbAnt;
        let filtrados = data.filter(item => 
            (dbName === 'dbCIE' ? (item.c + item.d) : item).toUpperCase().includes(query.toUpperCase())
        );

        filtrados.forEach(item => {
            let div = document.createElement('div');
            div.innerText = dbName === 'dbCIE' ? `${item.c} - ${item.d}` : item;
            div.onclick = () => {
                const target = document.getElementById(targetId);
                target.value += (target.value ? "\n" : "") + div.innerText;
                resDiv.style.display = 'none';
            };
            resDiv.appendChild(div);
        });
        resDiv.style.display = 'block';
    }

    // EXAMEN FÍSICO AUTOMÁTICO
    function actualizarEF() {
        let relato = "";
        document.querySelectorAll('#efInputs select').forEach(sel => {
            relato += sel.value + " ";
        });
        document.getElementById('efFinal').value = relato;
    }

    // LÓGICA DE HIDRATACIÓN (EL CORAZÓN DEL SISTEMA)
    function recalcularFluidos() {
        const pesoKg = parseFloat(document.getElementById('p_actual').value) / 1000;
        let lt = parseFloat(document.getElementById('lt_meta').value) || 0;
        const dex = parseFloat(document.getElementById('dexPerc').value) || 0;

        // Ajustes
        const base = lt;
        if(document.getElementById('foto').checked) lt += base * 0.15;
        if(document.getElementById('cuna').checked) lt += base * 0.15;

        const volTotalDia = lt * pesoKg;

        // Descuento Dieta
        let vDieta = 0;
        if(document.getElementById('tipoDieta').value === "LM") {
            document.getElementById('boxDieta').style.display = 'inline';
            vDieta = (parseFloat(document.getElementById('dietCant').value) || 0) * (24 / (parseFloat(document.getElementById('dietFreq').value) || 1));
        } else { document.getElementById('boxDieta').style.display = 'none'; }

        // Descuento Meds
        let vMedsDia = 0;
        listaMedicamentos.forEach((m, i) => {
            let vDia = ((pesoKg * m.d) / m.c) * (24 / m.f);
            document.getElementById(`vol_${i}`).innerText = vDia.toFixed(2);
            if(m.b) vMedsDia += vDia;
        });

        // Calculo Final IV
        const volIV = Math.max(0, volTotalDia - vDieta - vMedsDia);
        const ritmo = (volIV / 24).toFixed(1);
        const vig = (volIV * dex) / (1440 * pesoKg);

        document.getElementById('resFinalIV').innerHTML = 
            `PLAN IV: Dextrosa al ${dex}% | Vol: ${volIV.toFixed(1)} ml en 24h | Ritmo: ${ritmo} ml/h | VIG Real: ${vig.toFixed(2)} mg/kg/min`;
    }

    // GESTIÓN DE MEDICAMENTOS
    function agregarMed() {
        listaMedicamentos.push({n:'', d:0, f:24, c:1, b:true});
        renderMedTable();
    }

    function renderMedTable() {
        const body = document.getElementById('bodyMed');
        body.innerHTML = '';
        listaMedicamentos.forEach((m, i) => {
            let options = '<option value="">--Seleccionar--</option>';
            for(let key in dbMeds) options += `<option value="${key}" ${m.n === key ? 'selected' : ''}>${key}</option>`;

            body.innerHTML += `
                <tr>
                    <td><select onchange="seleccionarMed(${i}, this.value)">${options}</select></td>
                    <td><input type="number" value="${m.d}" oninput="listaMedicamentos[${i}].d=this.value; recalcularFluidos()" style="width:50px"></td>
                    <td><input type="number" value="${m.f}" oninput="listaMedicamentos[${i}].f=this.value; recalcularFluidos()" style="width:40px"></td>
                    <td><input type="number" value="${m.c}" oninput="listaMedicamentos[${i}].c=this.value; recalcularFluidos()" style="width:50px"></td>
                    <td><input type="checkbox" ${m.b ? 'checked' : ''} onchange="listaMedicamentos[${i}].b=this.checked; recalcularFluidos()"></td>
                    <td><span id="vol_${i}">0</span> ml</td>
                    <td><button onclick="listaMedicamentos.splice(${i},1); renderMedTable()">✖</button></td>
                </tr>`;
        });
        recalcularFluidos();
    }

    function seleccionarMed(idx, val) {
        if(dbMeds[val]) {
            listaMedicamentos[idx] = { n: val, d: dbMeds[val].d, f: dbMeds[val].f, c: dbMeds[val].c, b: dbMeds[val].b };
        }
        renderMedTable();
    }

    window.onload = () => { 
        calcularEdades(); 
        actualizarEF(); 
        agregarMed(); 
    };
</script>
</body>
</html>
