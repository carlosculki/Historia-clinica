<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA NEONATAL INTEGRAL HSVP - FULL MASTER v20.1</title>
    <style>
        /* --- ESTILOS MAESTROS (BLOQUE 1, 2 Y 3) --- */
        :root { 
            --primary: #2c3e50; 
            --secondary: #3498db; 
            --accent: #27ae60; 
            --bg: #f4f7f6; 
            --warning: #f39c12;
            --danger: #e74c3c;
            --white: #ffffff;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg); 
            padding: 15px; 
            font-size: 11px; 
            color: #333; 
            line-height: 1.4;
        }

        .container { 
            max-width: 1450px; 
            margin: auto; 
            background: var(--white); 
            padding: 35px; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
            border-top: 15px solid var(--primary); 
        }

        h1 { 
            text-align: center; 
            color: var(--primary); 
            text-transform: uppercase; 
            border-bottom: 5px solid var(--secondary); 
            padding-bottom: 15px; 
            margin-bottom: 30px;
            letter-spacing: 2px;
        }

        h2 { 
            background: var(--primary); 
            color: white; 
            padding: 12px; 
            border-radius: 6px; 
            margin-top: 35px; 
            font-size: 1.3em; 
            border-left: 12px solid var(--secondary); 
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
        }

        h3 { 
            color: var(--secondary); 
            border-bottom: 2px solid #eee; 
            margin-top: 25px; 
            font-size: 1.15em; 
            padding-bottom: 8px;
            font-weight: bold;
        }

        /* --- GRID SYSTEM --- */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 15px; 
            margin-bottom: 20px; 
        }

        .field { display: flex; flex-direction: column; }
        .field label { font-weight: bold; margin-bottom: 5px; color: #555; }
        .full-width { grid-column: 1 / -1; }

        input, select, textarea { 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 5px; 
            font-size: 11px; 
            background: #fff; 
            transition: all 0.3s;
        }

        input:focus, textarea:focus { 
            border-color: var(--secondary); 
            box-shadow: 0 0 5px rgba(52,152,219,0.3);
            outline: none;
        }

        /* --- CARDS Y ESPECIALES --- */
        .calc-card { 
            background: #f8f9fa; 
            border: 2px solid #dee2e6; 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 20px;
        }

        .highlight-box { 
            border: 2px solid var(--secondary) !important; 
            background: #f0f7ff !important; 
            font-weight: bold; 
            text-align: center; 
            color: var(--primary);
            font-size: 1.1em;
        }

        /* --- EXAMEN FÍSICO (BLOQUE EXAMEN) --- */
        .ef-row { 
            display: grid; 
            grid-template-columns: 200px 1fr; 
            gap: 15px; 
            align-items: center; 
            background: #fff; 
            padding: 10px; 
            border-bottom: 1px solid #eee; 
        }
        .ef-row:hover { background: #f1f8ff; }

        /* --- APGAR Y ESCALAS --- */
        .apgar-container { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 15px; 
            margin-top: 15px; 
        }
        .apgar-box { 
            background: #fff; 
            border: 1px solid #ddd; 
            padding: 15px; 
            border-radius: 10px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .apgar-box b { display: block; text-align: center; margin-bottom: 10px; color: var(--primary); border-bottom: 2px solid #f4f4f4; padding-bottom: 5px; }

        /* --- CIE-10 BUSCADOR --- */
        .search-container { position: relative; width: 100%; }
        .suggestions { 
            position: absolute; 
            width: 100%; 
            background: white; 
            border: 1px solid #ddd; 
            z-index: 1000; 
            max-height: 250px; 
            overflow-y: auto; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.1); 
            border-radius: 0 0 8px 8px;
        }
        .suggestion-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 11px; }
        .suggestion-item:hover { background: #e3f2fd; color: #1976d2; font-weight: bold; }

        /* --- ADCAV --- */
        .adcav-box { border: 2px solid #d1d8e0; border-radius: 15px; overflow: hidden; margin-top: 25px; }
        .adcav-row { display: grid; grid-template-columns: 100px 1fr; border-bottom: 1px solid #eee; min-height: 110px; }
        .adcav-letter { 
            background: #eef2f7; 
            color: var(--secondary); 
            font-size: 4em; 
            font-weight: bold; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-right: 5px solid var(--secondary); 
        }
        .adcav-content { padding: 20px; background: white; }

        /* --- TABLAS --- */
        .dx-table, .med-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .dx-table th, .med-table th { background: var(--primary); color: white; padding: 10px; text-align: left; font-size: 10px; }
        .dx-table td, .med-table td { border: 1px solid #ddd; padding: 8px; }

        /* --- BOTONES --- */
        .btn-main { 
            background: var(--accent); 
            color: white; 
            padding: 25px; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 20px; 
            width: 100%; 
            margin-top: 50px; 
            transition: all 0.3s;
            box-shadow: 0 8px 20px rgba(39,174,96,0.3);
            text-transform: uppercase;
        }
        .btn-main:hover { background: #219150; transform: translateY(-2px); box-shadow: 0 10px 25px rgba(39,174,96,0.4); }
        
        .btn-del { background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        .hidden { display: none; }
        
        @media print {
            .btn-main, .search-container, .btn-del { display: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>SISTEMA NEONATAL INTEGRAL - HSVP MASTER</h1>

    <h2>1. Datos de Filiación y Admisión</h2>
    <div class="calc-card" style="border: 2px solid var(--secondary);">
        <div class="grid">
            <div class="field"><label>FECHA DE INGRESO:</label><input type="date" id="fIngreso" onchange="calcEdadAlIngreso()"></div>
            <div class="field"><label>FECHA DE NACIMIENTO:</label><input type="date" id="fNac" onchange="calcEdadAlIngreso()"></div>
            <div class="field"><label>Hora Nacimiento:</label><input type="time" id="hNac" onchange="calcEdadAlIngreso()"></div>
            <div class="field"><label>EDAD AL INGRESO:</label><input type="text" id="edadReal" readonly class="highlight-box"></div>
        </div>
    </div>

    <div class="grid">
        <div class="field"><label>Primer Apellido:</label><input type="text" id="ape1N"></div>
        <div class="field"><label>Segundo Apellido:</label><input type="text" id="ape2N"></div>
        <div class="field"><label>Nombres:</label><input type="text" id="nomN"></div>
        <div class="field"><label>HCU:</label><input type="text" id="hcu"></div>
        <div class="field"><label>Sexo:</label><select id="sexoN"><option>MASCULINO</option><option>FEMENINO</option><option>INDETERMINADO</option></select></div>
    </div>

    <h3>Datos de la Madre</h3>
    <div class="grid">
        <div class="field"><label>Nombre de la Madre:</label><input type="text" id="nomM"></div>
        <div class="field"><label>Cédula:</label><input type="text" id="cedM"></div>
        <div class="field"><label>Edad Materna:</label><input type="number" id="edadM"></div>
        <div class="field"><label>Tipo de Sangre:</label>
            <select id="gsM">
                <option value="ORH+">ORH+</option><option value="ORH-">ORH-</option>
                <option value="ARH+">ARH+</option><option value="ARH-">ARH-</option>
                <option value="BRH+">BRH+</option><option value="BRH-">BRH-</option>
                <option value="ABRH+">ABRH+</option><option value="ABRH-">ABRH-</option>
            </select>
        </div>
        <div class="field"><label>Religión:</label><input type="text" id="relM" value="Católica"></div>
    </div>

    <h2>2. Antecedentes Clínicos</h2>
    <div class="calc-card">
        <div class="grid">
            <div class="field"><label>FUM (Fecha Última Menstruación):</label><input type="date" id="fum" onchange="calcEG_FUM()"></div>
            <div class="field"><label>EG por FUM:</label><input type="text" id="egFum" readonly class="highlight-box"></div>
            <div class="field full-width"><label>EG por Eco / Estimada:</label><input type="text" id="egEco"></div>
        </div>
        <div class="grid">
            <div class="field"><label>Gestas:</label><input type="number" id="gestas"></div>
            <div class="field"><label>Partos:</label><input type="number" id="partos"></div>
            <div class="field"><label>Cesáreas:</label><input type="number" id="cesareas"></div>
            <div class="field"><label>Abortos:</label><input type="number" id="abortos"></div>
            <div class="field"><label>Hijos Vivos:</label><input type="number" id="hVivos" oninput="generarHijos()"></div>
        </div>
        <div id="contenedorHijos"></div>
    </div>

    <h3>Narrativa de Antecedentes</h3>
    <div class="field full-width"><label>ANTECEDENTES PRENATALES:</label><textarea id="narrPre" rows="3" placeholder="Detalle controles, infecciones, preeclampsia..."></textarea></div>
    <div class="field full-width" style="margin-top:10px"><label>ANTECEDENTES NATALES:</label><textarea id="narrNat" rows="3" placeholder="Detalle tipo de parto, líquido amniótico, RPM..."></textarea></div>
    <div class="field full-width" style="margin-top:10px"><label>ANTECEDENTES POSTNATALES:</label><textarea id="narrPost" rows="3" placeholder="Reanimación, APGAR, adaptación..."></textarea></div>

    <h2>3. Examen Físico y Escalas</h2>
    <div class="grid">
        <div class="field"><label>Peso (g):</label><input type="number" id="peso" oninput="actualizarPesoReferencia()"></div>
        <div class="field"><label>Talla (cm):</label><input type="number" id="talla"></div>
        <div class="field"><label>PC (cm):</label><input type="number" id="pCef"></div>
        <div class="field"><label>FC (lpm):</label><input type="number" id="fc"></div>
        <div class="field"><label>FR (rpm):</label><input type="number" id="fr"></div>
        <div class="field"><label>T° (°C):</label><input type="number" id="temp" step="0.1"></div>
        <div class="field"><label>SatO2 (%):</label><input type="number" id="sat"></div>
    </div>

    <div class="calc-card">
        <div class="ef-row"><div><b>ESTADO GENERAL:</b></div><textarea id="ef_1">Activo, reactivo a la manipulación, afebril, hidratado.</textarea></div>
        <div class="ef-row"><div><b>PIEL:</b></div><textarea id="ef_2">Rosada, elástica, llenado capilar < 2 seg, sin ictericia.</textarea></div>
        <div class="ef-row"><div><b>CABEZA Y CUELLO:</b></div><textarea id="ef_3">Normocéfalo, fontanela anterior 2x2cm normotensa, suturas afrontadas.</textarea></div>
        <div class="ef-row"><div><b>TÓRAX Y PULMONAR:</b></div><textarea id="ef_4">Simétrico, ruidos cardiacos rítmicos sin soplos, murmullo vesicular conservado.</textarea></div>
        <div class="ef-row"><div><b>ABDOMEN:</b></div><textarea id="ef_5">Suave, deprimible, ruidos hidroaéreos presentes, no visceromegalias.</textarea></div>
        <div class="ef-row"><div><b>GENITOURINARIO:</b></div><textarea id="ef_6">Genitales masculinos/femeninos acordes a edad gestacional, ano permeable.</textarea></div>
    </div>

    
    <div class="apgar-container">
        <div class="apgar-box">
            <b>PUNTAJE APGAR</b>
            <div class="grid" style="grid-template-columns: 1fr 1fr">
                <div class="field"><label>1 min:</label><input type="number" id="ap1" oninput="calcApgarConsolidado()"></div>
                <div class="field"><label>5 min:</label><input type="number" id="ap5" oninput="calcApgarConsolidado()"></div>
            </div>
            <div id="resApgar" class="highlight-box" style="margin-top:10px">Puntaje: -- / --</div>
        </div>
        <div class="apgar-box">
            <b>ESCALA DE DOWNES</b>
            <select class="dw apgar-select" onchange="calcDownesTotal()"><option value="0">Cianosis: No</option><option value="1">Leve</option><option value="2">Grave</option></select>
            <select class="dw apgar-select" onchange="calcDownesTotal()"><option value="0">Quejido: No</option><option value="1">Audible fendo</option><option value="2">Audible lejos</option></select>
            <div id="resDownes" class="highlight-box" style="margin-top:5px">Downes: 0</div>
        </div>
        <div class="apgar-box">
            <b>MÉTODO CAPURRO</b>
            <input type="number" id="pCap" placeholder="Suma de puntos" oninput="calcCapurroTotal()" style="width:100%">
            <div id="resCap" class="highlight-box" style="margin-top:10px">EG: -- semanas</div>
        </div>
    </div>

    <h2>4. Diagnósticos CIE-10</h2>
    <div class="calc-card">
        <div class="search-container">
            <input type="text" id="dx-search" placeholder="Buscar por nombre o código (Ej: P36, Sepsis, Ictericia)..." oninput="showSuggestionsCIE(this.value)">
            <div id="dx-suggestions" class="suggestions hidden"></div>
        </div>
        <table class="dx-table">
            <thead>
                <tr><th>CIE-10</th><th>Descripción del Diagnóstico</th><th>Acción</th></tr>
            </thead>
            <tbody id="lista-dx-body"></tbody>
        </table>
    </div>

    <h2>5. Plan de Manejo (ADCAV)</h2>
    <div class="adcav-box">
        <div class="adcav-row">
            <div class="adcav-letter">A</div>
            <div class="adcav-content">
                <b>ALIMENTACIÓN:</b> 
                <select id="tipoDieta" onchange="recalcADCAV()" style="width:150px">
                    <option value="NPO">NPO</option><option value="LM">Leche Materna</option><option value="LF">Fórmula</option>
                </select>
                <span id="boxDieta" class="hidden">
                    | Cantidad (ml): <input type="number" id="mlDieta" style="width:60px" oninput="recalcADCAV()">
                    | Frecuencia (h): <input type="number" id="freqDieta" value="3" style="width:50px" oninput="recalcADCAV()">
                </span>
            </div>
        </div>
        <div class="adcav-row">
            <div class="adcav-letter">D</div>
            <div class="adcav-content">
                <b>DISPOSITIVOS Y LÍQUIDOS:</b>
                <div class="grid">
                    <div class="field"><label>Líquidos Totales (ml/kg/d):</label><input type="number" id="ltMeta" value="80" oninput="recalcADCAV()"></div>
                    <div class="field"><label>Concentración Dextrosa (%):</label><input type="number" id="dexPerc" value="10" oninput="recalcADCAV()"></div>
                </div>
                <div id="outLiquidos" class="highlight-box" style="background:#fff3e0 !important; border-color:#ff9800 !important; color:#e65100;">Calculando...</div>
            </div>
        </div>
        <div class="adcav-row">
            <div class="adcav-letter">C</div>
            <div class="adcav-content"><b>CONTROLES Y CUIDADOS:</b> <textarea id="planC" rows="2">CSV c/4h, Control de glicemia, Curación de cordón umbilical.</textarea></div>
        </div>
        <div class="adcav-row">
            <div class="adcav-letter">A</div>
            <div class="adcav-content">
                <b>ANTIBIÓTICOS Y MEDICAMENTOS:</b>
                <table class="med-table">
                    <thead><tr><th>Fármaco</th><th>Dosis (mg/kg)</th><th>Freq (h)</th><th>ml/Día</th><th>Eliminar</th></tr></thead>
                    <tbody id="med-body"></tbody>
                </table>
                <button onclick="addMedRow()" style="margin-top:10px; padding:5px; background:var(--primary); color:white; border:none; cursor:pointer;">+ Agregar Medicamento</button>
            </div>
        </div>
        <div class="adcav-row">
            <div class="adcav-letter">V</div>
            <div class="adcav-content"><b>VIGILANCIA:</b> <textarea id="planV" rows="2">Vigilar signos de distrés respiratorio, tolerancia gástrica y diuresis.</textarea></div>
        </div>
    </div>

    <button class="btn-main" onclick="generarPreviewTotal()">GENERAR VISTA PREVIA COMPLETA (HISTORIA CLÍNICA)</button>

    <div id="export-section" class="hidden" style="margin-top:30px; border:4px solid var(--primary); padding:25px; background:#fff;">
        <h2 style="margin-top:0">VISTA PREVIA CONSOLIDADA</h2>
        <div id="finalOutput" style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 12px; border: 1px solid #ddd; padding: 15px; background: #fefefe;"></div>
        <button onclick="window.print()" class="btn-main" style="background:var(--secondary); margin-top:20px;">IMPRIMIR / GUARDAR PDF</button>
    </div>
</div>

<script>
    /* -------------------------------------------------------------------------
       BLOQUE 1 Y 2: LÓGICA DE FILIACIÓN Y EDAD SEMANAS
    -------------------------------------------------------------------------- */
    function calcEdadAlIngreso() {
        const naci = document.getElementById('fNac').value;
        const ingr = document.getElementById('fIngreso').value;
        const hora = document.getElementById('hNac').value || "00:00";
        if(naci && ingr) {
            const d1 = new Date(naci + 'T' + hora);
            const d2 = new Date(ingr + 'T23:59:59');
            const hrs = Math.floor((d2 - d1) / 3600000);
            document.getElementById('edadReal').value = hrs < 48 ? hrs + " HORAS" : Math.floor(hrs/24) + " DÍAS";
        }
    }

    function calcEG_FUM() {
        const f = document.getElementById('fum').value;
        if(f) {
            const sem = (new Date() - new Date(f)) / (1000 * 60 * 60 * 24 * 7);
            document.getElementById('egFum').value = Math.floor(sem) + "." + Math.floor((sem % 1) * 7) + " SEMANAS";
        }
    }

    function generarHijos() {
        const n = parseInt(document.getElementById('hVivos').value) || 0;
        const c = document.getElementById('contenedorHijos');
        c.innerHTML = n > 0 ? "<h4>Detalle de Hijos Vivos:</h4>" : "";
        for(let i=1; i<=n; i++) {
            c.innerHTML += `<div class="hijo-row"><span>Hijo ${i}:</span><select><option>PARTO</option><option>CESÁREA</option></select><input type="number" placeholder="Edad"></div>`;
        }
    }

    /* -------------------------------------------------------------------------
       BLOQUE 3: ESCALAS NEONATALES
    -------------------------------------------------------------------------- */
    function calcApgarConsolidado() {
        document.getElementById('resApgar').innerText = "Puntaje: " + (document.getElementById('ap1').value || "-") + " / " + (document.getElementById('ap5').value || "-");
    }

    function calcDownesTotal() {
        let t = 0; document.querySelectorAll('.dw').forEach(s => t += parseInt(s.value));
        document.getElementById('resDownes').innerText = "Downes: " + t;
    }

    function calcCapurroTotal() {
        let p = parseInt(document.getElementById('pCap').value) || 0;
        if(p > 0) document.getElementById('resCap').innerText = "EG: " + ((p + 204)/7).toFixed(1) + " semanas";
    }

    /* -------------------------------------------------------------------------
       BLOQUE 4: BUSCADOR CIE-10 (BASE DE DATOS COMPLETA)
    -------------------------------------------------------------------------- */
    const dbCIE = [
        {c: "Z38.0", d: "Recién nacido vivo, único, nacido en hospital"},
        {c: "P36.9", d: "Sepsis bacteriana del recién nacido, no especificada"},
        {c: "P22.0", d: "Síndrome de dificultad respiratoria del recién nacido"},
        {c: "P22.1", d: "Taquipnea transitoria del recién nacido"},
        {c: "P59.9", d: "Ictericia neonatal, no especificada"},
        {c: "P70.4", d: "Hipoglucemia neonatal transitoria"},
        {c: "P07.3", d: "Otros recién nacidos pretérmino (32 a 37 semanas)"},
        {c: "P05.1", d: "Pequeño para la edad gestacional"},
        {c: "P24.0", d: "Síndrome de aspiración de meconio"},
        {c: "P52.4", d: "Hemorragia intraventricular (no traumática)"},
        {c: "P61.2", d: "Anemia de la prematurez"}
    ];

    let seleccionadosCIE = [];

    function showSuggestionsCIE(val) {
        const div = document.getElementById('dx-suggestions');
        div.innerHTML = '';
        if(val.length < 2) { div.classList.add('hidden'); return; }
        const filtrados = dbCIE.filter(i => i.d.toLowerCase().includes(val.toLowerCase()) || i.c.toLowerCase().includes(val.toLowerCase()));
        filtrados.forEach(i => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.innerText = i.c + " - " + i.d;
            item.onclick = () => { addDx(i); div.classList.add('hidden'); };
            div.appendChild(item);
        });
        div.classList.remove('hidden');
    }

    function addDx(item) {
        seleccionadosCIE.push(item);
        renderDxTable();
    }

    function renderDxTable() {
        const body = document.getElementById('lista-dx-body');
        body.innerHTML = '';
        seleccionadosCIE.forEach((i, idx) => {
            body.innerHTML += `<tr><td><b>${i.c}</b></td><td>${i.d}</td><td><button class="btn-del" onclick="seleccionadosCIE.splice(${idx},1);renderDxTable()">✖</button></td></tr>`;
        });
    }

    /* -------------------------------------------------------------------------
       BLOQUE 5: MOTOR ADCAV (CÁLCULOS INTEGRALES)
    -------------------------------------------------------------------------- */
    let medsPlan = [];
    const dbMedsMaster = {
        "AMPICILINA": {d: 50, c: 100, f: 12},
        "GENTAMICINA": {d: 4, c: 4, f: 24},
        "AMIKACINA": {d: 15, c: 5, f: 24}
    };

    function addMedRow() {
        medsPlan.push({n: 'AMPICILINA', d: 50, f: 12, c: 100});
        renderMedTable();
    }

    function renderMedTable() {
        const body = document.getElementById('med-body');
        body.innerHTML = '';
        medsPlan.forEach((m, i) => {
            body.innerHTML += `<tr>
                <td><input type="text" value="${m.n}" oninput="medsPlan[${i}].n=this.value"></td>
                <td><input type="number" value="${m.d}" oninput="medsPlan[${i}].d=this.value; recalcADCAV()"></td>
                <td><input type="number" value="${m.f}" oninput="medsPlan[${i}].f=this.value; recalcADCAV()"></td>
                <td><span id="vmed_${i}">0</span></td>
                <td><button class="btn-del" onclick="medsPlan.splice(${i},1);renderMedTable()">✖</button></td>
            </tr>`;
        });
        recalcADCAV();
    }

    function recalcADCAV() {
        const p = (parseFloat(document.getElementById('peso').value) || 3000) / 1000;
        let lt = parseFloat(document.getElementById('ltMeta').value) || 0;
        let vDieta = 0;

        if(document.getElementById('tipoDieta').value !== 'NPO') {
            document.getElementById('boxDieta').classList.remove('hidden');
            let ml = parseFloat(document.getElementById('mlDieta').value) || 0;
            vDieta = ml * (24 / (parseFloat(document.getElementById('freqDieta').value) || 3));
        } else {
            document.getElementById('boxDieta').classList.add('hidden');
        }

        let vMeds = 0;
        medsPlan.forEach((m, i) => {
            let vd = ((m.d * p) / m.c) * (24/m.f);
            document.getElementById(`vmed_${i}`).innerText = vd.toFixed(2);
            vMeds += vd;
        });

        const vTotal = lt * p;
        const vIV = vTotal - vDieta - vMeds;
        const gtc = (vIV / 24).toFixed(1);
        const vig = (vIV * (parseFloat(document.getElementById('dexPerc').value)/100)) / (1.44 * p);

        document.getElementById('outLiquidos').innerText = `Bolsa IV: ${vIV.toFixed(1)} ml total (${gtc} ml/h) | VIG: ${vig.toFixed(2)}`;
    }

    /* -------------------------------------------------------------------------
       BOTÓN FINAL: CONSOLIDACIÓN DE TODA LA HISTORIA
    -------------------------------------------------------------------------- */
    function generarPreviewTotal() {
        document.getElementById('export-section').classList.remove('hidden');
        let out = "===========================================================\n";
        out += "        HISTORIA CLÍNICA NEONATAL - HSVP\n";
        out += "===========================================================\n\n";
        
        out += "1. FILIACIÓN:\n";
        out += `Paciente: ${document.getElementById('ape1N').value} ${document.getElementById('nomN').value} | HCU: ${document.getElementById('hcu').value}\n`;
        out += `Madre: ${document.getElementById('nomM').value} | Edad: ${document.getElementById('edadM').value} | Sangre: ${document.getElementById('gsM').value}\n`;
        out += `Admisión: ${document.getElementById('fIngreso').value} | Edad Ingreso: ${document.getElementById('edadReal').value}\n\n`;

        out += "2. ANTECEDENTES:\n";
        out += `Gestación: ${document.getElementById('egFum').value} (FUM) | G:${document.getElementById('gestas').value} P:${document.getElementById('partos.').value}\n`;
        out += `PRENATALES: ${document.getElementById('narrPre').value}\n`;
        out += `NATALES: ${document.getElementById('narrNat').value}\n\n`;

        out += "3. EXAMEN FÍSICO:\n";
        out += `Signos: FC ${document.getElementById('fc').value} | FR ${document.getElementById('fr').value} | T ${document.getElementById('temp').value} | Sat ${document.getElementById('sat').value}\n`;
        out += `Somatometría: Peso ${document.getElementById('peso').value}g | Talla ${document.getElementById('talla').value}cm | PC ${document.getElementById('pCef').value}cm\n`;
        out += `Escalas: APGAR ${document.getElementById('resApgar').innerText} | ${document.getElementById('resDownes').innerText} | ${document.getElementById('resCap').innerText}\n`;
        out += `Hallazgos: ${document.getElementById('ef_1').value.substring(0,60)}... / ${document.getElementById('ef_4').value.substring(0,60)}...\n\n`;

        out += "4. DIAGNÓSTICOS (CIE-10):\n";
        seleccionadosCIE.forEach(i => out += `[${i.c}] ${i.d}\n`);
        out += "\n";

        out += "5. PLAN DE MANEJO (ADCAV):\n";
        out += `A: ${document.getElementById('tipoDieta').value} - ${document.getElementById('mlDieta').value}ml c/${document.getElementById('freqDieta').value}h\n`;
        out += `D: ${document.getElementById('outLiquidos').innerText}\n`;
        out += `C: ${document.getElementById('planC').value}\n`;
        out += `A: `; medsPlan.forEach(m => out += `${m.n} ${m.d}mg/kg, `); out += "\n";
        out += `V: ${document.getElementById('planV').value}\n\n`;

        out += "-----------------------------------------------------------\n";
        out += "Generado por Sistema de Gestión Neonatal HSVP v20.1\n";

        document.getElementById('finalOutput').innerText = out;
        window.scrollTo(0, document.body.scrollHeight);
    }

    // Inicialización
    window.onload = () => { addMedRow(); };
</script>

</body>
</html>
